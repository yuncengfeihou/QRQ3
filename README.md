**Overall Purpose:**
The "QRQ" extension provides a custom, highly configurable quick reply menu. It aims to replace/augment SillyTavern's native Quick Reply v2 functionality and integrate with "JS-Slash-Runner" to offer a unified interface for various quick actions. It features a rocket button trigger, customizable menu appearance, and various icon options for the trigger button.

**Core Files and Their Responsibilities:**

1.  **`manifest.json` (v1.8.5)**
    *   **`display_name`**: "QRQ" - How the extension is shown in SillyTavern.
    *   **`loading_order`**: 1 - Indicates it should load relatively early.
    *   **`js`**: "index.js" - The main entry point for JavaScript.
    *   **`css`**: "style.css" - The stylesheet for the extension.
    *   **`author`**: "uhhhh15"
    *   **Dependencies**: None explicitly listed in `requires`, meaning it expects core SillyTavern and potentially other common extensions (like Quick Reply v2, JS-Slash-Runner) to be present.

2.  **`index.js` (Main Entry Point)**
    *   **Initialization**: Sets up the global `window.extension_settings[EXTENSION_NAME]` object with default values if it doesn't exist.
    *   **UI Injection**:
        *   `injectRocketButton()`: Creates and inserts the main trigger button (rocket icon by default) next to SillyTavern's send button.
        *   `createMenuElement()` (from `ui.js`): Creates the main menu structure.
    *   **State Management**: Populates `sharedState.domElements` (from `state.js`) with references to the created UI elements.
    *   **Global API**: Exposes `window.quickReplyMenu` with functions like `handleQuickReplyClick` (for menu item clicks) and `saveSettings`.
    *   **Settings Loading**:
        *   `loadSettingsFromLocalStorage()`: A fallback mechanism.
        *   `loadAndApplyInitialSettings()`: Applies loaded settings to the extension's behavior and UI (e.g., button visibility, icon style).
    *   **Event Listener Setup**: Calls `setupEventListeners()` (from `events.js`).
    *   **Settings Panel Integration**:
        *   Injects the settings HTML (generated by `createSettingsHtml()` from `settings.js`) into SillyTavern's `#extensions_settings` area.
        *   **Crucially, it waits for SillyTavern's `EXTENSION_SETTINGS_LOADED` event (or uses a timeout fallback) before performing full plugin initialization (`performInitialization()`). This is vital to ensure that settings from other extensions (like JS-Slash-Runner, which it reads from) are available.**
        *   `performInitialization()` then calls `initializePlugin()` and `loadAndApplySettingsToPanel()` (from `settings.js`) to populate the settings UI.

3.  **`constants.js` (Centralized Definitions)**
    *   `EXTENSION_NAME`: "quick-reply-menu" - Used as a key for settings and in logs.
    *   **DOM IDs**: Defines a comprehensive list of IDs for all major UI elements (rocket button, menu, settings panel, style panel, usage panel, input fields, etc.). This is crucial for consistent DOM manipulation.
    *   **CSS Classes**: Defines class names used for styling and identifying element types.
    *   **ARIA Roles**: For accessibility.
    *   **Icon Definitions**: `ICON_TYPES` (e.g., `ROCKET`, `CUSTOM`, `FONTAWESOME`) and `ICON_CLASS_MAP` (mapping types to FontAwesome classes).
    *   **Default Values**: `DEFAULT_MENU_STYLES`, `DEFAULT_CUSTOM_ICON_SIZE`.

4.  **`state.js` (Shared Runtime State)**
    *   `sharedState`: A simple object containing:
        *   `menuVisible`: Boolean, tracks if the quick reply menu is open.
        *   `domElements`: References to key DOM elements (rocket button, menu, item containers).
        *   `currentSelectedSavedIconId`: Tracks which saved custom icon is currently selected in the settings.
    *   `setMenuVisible()`: A setter function for `menuVisible`.

5.  **`api.js` (Data Fetching and External Interactions)**
    *   **SillyTavern Context**: Accesses `SillyTavern.getContext()` for interacting with SillyTavern's systems.
    *   **JS-Slash-Runner Integration**: Defines keys (`JSR_SETTINGS_KEY`, `JSR_CHAR_EXTENSION_KEY`) to access JS-Slash-Runner settings.
    *   `fetchQuickReplies()`:
        *   Fetches standard Quick Reply v2 items from `window.quickReplyApi` (if available and enabled).
        *   Fetches JS-Slash-Runner script buttons by reading `stContext.extensionSettings[JSR_SETTINGS_KEY]`. It handles global and character-specific scripts, checking enablement flags.
        *   Merges JS-Slash-Runner buttons into the "chat" replies category.
        *   Distinguishes replies with `isStandard` and `source` properties.
    *   `triggerQuickReply()`: Executes a standard Quick Reply v2 item via `window.quickReplyApi.executeQuickReply()`.
    *   `triggerJsRunnerScript()`: Triggers a JS-Slash-Runner script button by emitting a specific event (`<scriptId>_<buttonLabel>`) via `stContext.eventSource.emit()`.

6.  **`ui.js` (User Interface Creation and Rendering)**
    *   `createMenuElement()`: Constructs the HTML structure for the quick reply menu (hidden by default), including "Chat" and "Global" sections with titles and item containers.
    *   `createQuickReplyItem()`: Creates a single button element for a quick reply. It sets `data-` attributes:
        *   `data-label`: The reply label.
        *   `data-is-standard`: `true` for standard QR, `false` for JS Runner.
        *   `data-set-name`: The set name (for standard QR) or script name (for JS Runner).
        *   `data-script-id`: The script ID (for JS Runner).
        *   Sets a tooltip.
    *   `renderQuickReplies()`:
        *   Clears existing items from the menu.
        *   Populates the "Chat" and "Global" sections with items created by `createQuickReplyItem()`.
        *   **Attaches click listeners to each item, which call `window.quickReplyMenu.handleQuickReplyClick` (defined in `events.js`).**
        *   Handles empty states by showing a placeholder message.
    *   `createEmptyPlaceholder()`: Helper to create the "no replies" message.
    *   `updateMenuVisibilityUI()`:
        *   Controls the display (`block`/`none`) of the main menu.
        *   If showing the menu, it first calls `fetchQuickReplies()` (from `api.js`) and then `renderQuickReplies()` to populate it with the latest data.
        *   Updates ARIA attributes on the rocket button.

7.  **`events.js` (Event Handling Logic)**
    *   `handleRocketButtonClick()`: Toggles menu visibility (`sharedState.menuVisible`) and calls `updateMenuVisibilityUI()`.
    *   `handleOutsideClick()`: Closes the main menu, style panel, or usage panel if a click occurs outside of them and their respective trigger buttons.
    *   `handleQuickReplyClick()`:
        *   The core handler for clicks on menu items (buttons).
        *   Reads `data-` attributes from the clicked button.
        *   If `isStandard` is true, calls `triggerQuickReply()` (from `api.js`).
        *   If `isStandard` is false, calls `triggerJsRunnerScript()` (from `api.js`).
        *   Closes the menu after action.
    *   **Menu Style Panel Logic**:
        *   `handleMenuStyleButtonClick()`: Shows the style panel and calls `loadMenuStylesIntoPanel()`.
        *   `loadMenuStylesIntoPanel()`: Populates the style panel's input fields (color pickers, sliders) with values from `extension_settings[EXTENSION_NAME].menuStyles`.
        *   `closeMenuStylePanel()`: Hides the style panel.
        *   `applyMenuStyles()`: Reads values from the style panel, updates `extension_settings[EXTENSION_NAME].menuStyles`, calls `updateMenuStylesUI()`, and closes the panel.
        *   `resetMenuStyles()`: Resets `menuStyles` to `DEFAULT_MENU_STYLES`, reloads the panel, and calls `updateMenuStylesUI()`.
    *   `updateMenuStylesUI()`: Applies the current `menuStyles` to CSS custom properties (e.g., `--qr-item-bg-color`) on `document.documentElement`, which `style.css` then uses for theming.
    *   **Color Utilities**: `hexToRgba`, `rgbaToHex`, `getOpacityFromRgba` for style conversions.
    *   `setupColorPickerSync()`: Ensures color picker inputs and their associated hex text inputs stay synchronized.
    *   `setupEventListeners()`:
        *   Attaches listeners for the rocket button and document-level outside clicks.
        *   Attaches listeners to various settings elements (enable dropdown, icon type, custom URL, etc.), typically calling `handleSettingsChange` (from `settings.js`).
        *   Attaches listeners for style panel controls (close, apply, reset) and opacity sliders.
        *   Calls `setupColorPickerSync()`.

8.  **`settings.js` (Settings Panel UI and Logic)**
    *   `updateIconDisplay()`: **A key function.** Updates the appearance of the rocket button based on current settings (icon type, custom URL/SVG/Base64, custom size, FontAwesome code, global size). It dynamically sets background images or inner HTML (for FontAwesome). It also ensures the button matches SillyTavern's `primary-button` or `secondary-button` style.
    *   `createSettingsHtml()`: Generates the entire HTML string for the extension's settings section within SillyTavern. This is a large chunk of HTML defining:
        *   Enable/disable controls.
        *   Icon type selection and associated inputs.
        *   Custom icon management (URL input, file upload, size, save, select, delete).
        *   FontAwesome code input.
        *   Global icon size input.
        *   Buttons to open the "Menu Style" panel and "Usage Instructions" panel.
        *   The "Save Settings" button.
        *   The HTML for the `ID_MENU_STYLE_PANEL` (style customization) and `ID_USAGE_PANEL` (help text).
    *   `handleUsageButtonClick()`, `closeUsagePanel()`: Show/hide the usage instructions panel.
    *   `handleSettingsChange()`: Central handler for when a setting UI element changes. It updates the corresponding value in `extension_settings[EXTENSION_NAME]` and calls `updateIconDisplay()` to reflect changes immediately on the rocket button. Manages visibility of conditional UI parts (e.g., custom icon inputs only show if "Custom" type is selected).
    *   `saveSettings()`: Saves the current `extension_settings[EXTENSION_NAME]` to `context.saveExtensionSettings()` (SillyTavern's mechanism) and as a fallback to `localStorage`.
    *   `setupSettingsEventListeners()`: Adds specific event listeners for elements within the settings panel, such as file upload (`handleFileUpload`), save button, custom icon management buttons (save, select, delete), and reset global icon size.
    *   `handleFileUpload()`: Handles the `change` event from the file input. Reads the file as a Data URL. If the Data URL is very long, it stores the full URL in `settings.customIconUrl` (and `dataset.fullValue` on the input element) but displays a placeholder text in the input field for performance.
    *   `loadAndApplySettings()`: Populates the settings panel UI elements (dropdowns, inputs) with values from `extension_settings[EXTENSION_NAME]` when the settings panel is initialized. This is called by `index.js` after the settings HTML is injected.
    *   **Custom Icon Management**:
        *   `saveCustomIcon()`: Prompts for a name and saves the current custom icon URL and size to `settings.savedCustomIcons`.
        *   `updateCustomIconSelect()`: Populates the "select saved icon" dropdown.
        *   `handleCustomIconSelect()`: Applies a selected saved icon to the current settings.
        *   `handleDeleteSavedIcon()`: Removes a saved icon from the list and clears inputs if the deleted icon was in use.
    *   `handleResetIconSize()`: Resets the global icon size setting.

9.  **`style.css` (Styling)**
    *   Provides all visual styling for the extension.
    *   Styles for the rocket button (`#quick-reply-rocket-button`), including its active state and how it handles different icon types (background images for custom, font size for FA).
    *   Styles for the main menu (`#quick-reply-menu`), its containers, lists, titles, items, and empty placeholders.
    *   **CSS Custom Properties**: Defines variables like `--qr-item-bg-color`, `--qr-menu-bg-color`, etc., which are dynamically updated by `events.js -> updateMenuStylesUI()` based on user configuration in the style panel. This allows for live theming of the menu.
    *   Styles for the settings panel section, including rows, labels, inputs.
    *   Styles for the specialized "Menu Style Panel" (`#quick-reply-menu-menu-style-panel`) and "Usage Panel" (`.qr-usage-panel`), including color pickers, sliders, and text formatting.
    *   Responsive styles (`@media screen and (max-width: 768px)`) to adapt the layout for smaller screens.
    *   **Crucially, it includes rules to hide SillyTavern's native Quick Reply v2 UI (`#qr--bar`) when this extension is enabled (`body.qra-enabled`), effectively replacing it.**

**Key Architectural Points & Interactions:**

*   **Modularity**: Clear separation of concerns (UI, events, API, settings, state, constants).
*   **Centralized Settings**: `window.extension_settings[Constants.EXTENSION_NAME]` acts as the single source of truth for persistent settings, managed primarily by `settings.js` and initialized/saved via `index.js`.
*   **Dynamic UI**:
    *   The rocket button's icon is dynamically updated by `settings.js -> updateIconDisplay()`.
    *   The menu's content is dynamically fetched and rendered by `ui.js -> updateMenuVisibilityUI()` (which calls `api.js -> fetchQuickReplies()` and `ui.js -> renderQuickReplies()`) each time it's opened.
    *   The menu's theme is live-updated via CSS custom properties manipulated by `events.js -> updateMenuStylesUI()`.
*   **Event-Driven**: Most actions are triggered by user events, handled in `events.js`, which then calls functions in other modules.
*   **Dependency on SillyTavern Environment**: Heavily integrated with SillyTavern's DOM, settings system (`context.saveExtensionSettings`, `SillyTavern.extensionSettings`), and event system (`SillyTavern.eventSource`).
*   **Integration with Other Extensions**:
    *   Reads from `window.quickReplyApi` (core Quick Reply v2).
    *   Reads settings from and triggers events for JS-Slash-Runner.
*   **Performance Consideration**: The handling of large base64 Data URLs for custom icons (showing a placeholder in the input field) is a good example of considering UI performance.

**Workflow Summary (Example: Opening Menu and Clicking an Item):**

1.  User clicks the **Rocket Button**.
2.  `events.js:handleRocketButtonClick()` is called.
3.  It toggles `sharedState.menuVisible` (via `state.js:setMenuVisible()`).
4.  It calls `ui.js:updateMenuVisibilityUI()`.
5.  `updateMenuVisibilityUI()` sees `menuVisible` is true:
    *   Calls `api.js:fetchQuickReplies()` to get standard and JS Runner items.
    *   Calls `ui.js:renderQuickReplies()` to build and display these items in the menu. Each item gets a click listener pointing to `window.quickReplyMenu.handleQuickReplyClick`.
    *   Makes the menu `div` visible.
6.  User clicks a **Menu Item** (a button).
7.  The attached listener calls `events.js:handleQuickReplyClick()`.
8.  `handleQuickReplyClick()` reads `data-` attributes from the button:
    *   If standard: calls `api.js:triggerQuickReply()` (which uses `window.quickReplyApi`).
    *   If JS Runner: calls `api.js:triggerJsRunnerScript()` (which uses `stContext.eventSource.emit()`).
9.  `handleQuickReplyClick()` then closes the menu by setting `sharedState.menuVisible = false` and calling `updateMenuVisibilityUI()` again.
